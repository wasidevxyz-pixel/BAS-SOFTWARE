<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zakat Report - Print</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .container {
                max-width: 100% !important;
            }
        }

        body {
            background-color: #f8f9fa;
            font-size: 12px;
        }

        .report-container {
            background: white;
            padding: 20px 30px;
            margin: 20px auto;
            max-width: 900px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .report-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #2c5ba9;
            padding-bottom: 15px;
        }

        .report-header h2 {
            color: #2c5ba9;
            margin: 0;
            font-weight: bold;
        }

        .report-header p {
            margin: 5px 0 0;
            color: #666;
        }

        .report-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .report-info div {
            text-align: center;
        }

        .report-info label {
            font-weight: bold;
            color: #333;
            display: block;
        }

        .report-info span {
            color: #666;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .report-table thead th {
            background-color: #17a2b8;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }

        .report-table tbody td {
            padding: 8px 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .report-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .report-table tfoot td {
            background-color: #343a40;
            color: white;
            padding: 10px;
            font-weight: bold;
        }

        .summary-section {
            display: flex;
            justify-content: flex-end;
            gap: 30px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item label {
            font-weight: bold;
            display: block;
            color: #666;
        }

        .summary-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #2c5ba9;
        }

        .btn-print {
            background-color: #2c5ba9;
            color: white;
            padding: 8px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-print:hover {
            background-color: #1e4c8c;
            color: white;
        }

        .btn-close-report {
            background-color: #6c757d;
            color: white;
            padding: 8px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .action-bar {
            text-align: center;
            margin-bottom: 20px;
        }

        .pay-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
        }

        .receive-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <div class="action-bar no-print">
        <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> Print Report</button>
        <button class="btn-close-report" onclick="window.close()">Close</button>
    </div>

    <div class="report-container">
        <div class="report-header">
            <h2>Zakat Report</h2>
            <p id="reportSubtitle">Bilal Accounting System</p>
        </div>

        <div class="report-info">
            <div>
                <label>From Date</label>
                <span id="fromDateDisplay">-</span>
            </div>
            <div>
                <label>To Date</label>
                <span id="toDateDisplay">-</span>
            </div>
            <div>
                <label>Branch</label>
                <span id="branchDisplay">All Branches</span>
            </div>
            <div>
                <label>Generated On</label>
                <span id="generatedDate">-</span>
            </div>
        </div>

        <table class="report-table">
            <thead>
                <tr>
                    <th style="width: 8%">#</th>
                    <th style="width: 15%">Date</th>
                    <th style="width: 12%">Type</th>
                    <th style="width: 15%">Amount</th>
                    <th style="width: 15%">From Branch</th>
                    <th style="width: 35%">Remarks</th>
                </tr>
            </thead>
            <tbody id="reportTableBody">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px;">Loading...</td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" style="text-align: right;">Grand Total:</td>
                    <td id="grandTotal">0</td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>

        <div class="summary-section">
            <div class="summary-item">
                <label>Opening Balance</label>
                <div class="value" id="openingBalanceVal" style="color: #6c757d;">0</div>
            </div>
            <div class="summary-item">
                <label>Total Pay (Expense)</label>
                <div class="value" id="totalPay" style="color: #dc3545;">0</div>
            </div>
            <div class="summary-item">
                <label>Total Receive (Income)</label>
                <div class="value" id="totalReceive" style="color: #28a745;">0</div>
            </div>
            <div class="summary-item">
                <label>Closing Balance</label>
                <div class="value" id="netAmount" style="color: #17a2b8;">0</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/v1';

        document.addEventListener('DOMContentLoaded', async function () {
            await loadReportData();
        });

        async function loadReportData() {
            try {
                // Get URL parameters
                const params = new URLSearchParams(window.location.search);
                const fromDate = params.get('fromDate') || new Date().toISOString().split('T')[0];
                const toDate = params.get('toDate') || new Date().toISOString().split('T')[0];
                const branch = params.get('branch') || 'all';

                // Update display
                document.getElementById('fromDateDisplay').textContent = formatDate(fromDate);
                document.getElementById('toDateDisplay').textContent = formatDate(toDate);
                document.getElementById('branchDisplay').textContent = branch === 'all' ? 'All Branches' : branch;
                document.getElementById('generatedDate').textContent = new Date().toLocaleDateString('en-GB') + ' ' + new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

                // Fetch data
                const token = localStorage.getItem('token');
                let url = `${API_URL}/zakats/date-range?startDate=${fromDate}&endDate=${toDate}`;
                if (branch && branch !== 'all') {
                    url += `&branch=${encodeURIComponent(branch)}`;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const zakats = data.data || [];
                    renderReport(zakats, {
                        openingBalance: data.openingBalance || 0,
                        periodReceive: data.periodReceive || 0,
                        periodPay: data.periodPay || 0,
                        closingBalance: data.closingBalance || 0
                    });
                } else {
                    document.getElementById('reportTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading data</td></tr>';
                }
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('reportTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading data</td></tr>';
            }
        }

        function renderReport(zakats, balanceData = {}) {
            const tbody = document.getElementById('reportTableBody');
            const openingBalance = balanceData.openingBalance || 0;
            const periodReceive = balanceData.periodReceive || 0;
            const periodPay = balanceData.periodPay || 0;
            const closingBalance = balanceData.closingBalance || 0;

            let html = '';

            // Opening Balance Row
            html += `
                <tr style="background-color: #6c757d; color: white; font-weight: bold;">
                    <td colspan="3">Opening Balance</td>
                    <td>${formatNumber(openingBalance)}</td>
                    <td colspan="2"></td>
                </tr>
            `;

            if (zakats.length === 0) {
                html += '<tr><td colspan="6" style="text-align: center; padding: 20px;">No records found</td></tr>';
            } else {
                zakats.forEach((zakat, index) => {
                    const amount = zakat.amount || 0;
                    const badgeClass = zakat.type === 'Pay' ? 'pay-badge' : 'receive-badge';

                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${formatDate(zakat.date)}</td>
                            <td><span class="${badgeClass}">${zakat.type || 'Pay'}</span></td>
                            <td>${formatNumber(amount)}</td>
                            <td>${zakat.fromBranch || '-'}</td>
                            <td>${zakat.remarks || '-'}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;
            document.getElementById('grandTotal').textContent = formatNumber(periodReceive + periodPay);
            document.getElementById('totalPay').textContent = formatNumber(periodPay);
            document.getElementById('totalReceive').textContent = formatNumber(periodReceive);
            document.getElementById('netAmount').textContent = formatNumber(closingBalance);

            // Update opening balance in summary if element exists
            const openingEl = document.getElementById('openingBalanceVal');
            if (openingEl) openingEl.textContent = formatNumber(openingBalance);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB');
        }

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return parseFloat(num).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }
    </script>
</body>

</html>