<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Print</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #1a237e;
            --accent-color: #0d47a1;
            --table-header: #f8f9fa;
            --text-dark: #212121;
        }

        body {
            background: #f0f2f5;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text-dark);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .print-canvas {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        @media screen and (max-width: 1024px) {
            body {
                background: white;
            }

            .print-canvas {
                margin: 0 auto;
                box-shadow: none;
                transform-origin: top center;
                transform: scale(0.85);
                /* Slight fit for standard screens */
            }
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid var(--primary-dark);
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .company-logo {
            max-width: 180px;
            max-height: 80px;
            object-fit: contain;
        }

        .doc-title {
            text-align: right;
        }

        .doc-title h1 {
            font-size: 2.2rem;
            color: var(--primary-dark);
            margin: 0;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .doc-title p {
            margin: 0;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #fff;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.75rem;
            color: #757575;
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 0.85rem;
        }

        .main-table th {
            background-color: var(--primary-dark);
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .main-table td {
            padding: 4px 6px;
            border: 1px solid #e0e0e0;
        }

        .class-group-header {
            background-color: #f1f3f9;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .subtotal-row {
            background-color: #fafbfc;
            font-weight: 600;
        }

        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .totals-table {
            width: 100%;
            max-width: 320px;
        }

        .totals-table td {
            padding: 6px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .grand-total-box {
            background: var(--primary-dark);
            color: white;
            font-size: 1.25rem;
            font-weight: 800;
        }

        .footer-signatures {
            margin-top: 80px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
            text-align: center;
        }

        .sig-box {
            border-top: 2px solid #333;
            padding-top: 10px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .no-print-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        /* B&W Mode Styles */
        body.bw-mode .main-table th {
            background-color: #000 !important;
            color: #fff !important;
            border: 1px solid #fff !important;
        }

        body.bw-mode .grand-total-box {
            background-color: #000 !important;
            color: #fff !important;
            border: 2px solid #000 !important;
        }

        body.bw-mode .class-group-header {
            background-color: #333 !important;
            color: #fff !important;
            border: 1px solid #fff !important;
        }

        body.bw-mode .subtotal-row {
            background-color: #555 !important;
            color: #fff !important;
        }

        body.bw-mode .subtotal-row td {
            border: 1px solid #fff !important;
        }

        body.bw-mode .info-label {
            background-color: #e8e8e8 !important;
            color: #000 !important;
        }

        body.bw-mode .badge {
            background-color: #ccc !important;
            color: #000 !important;
        }

        body.bw-mode h1,
        body.bw-mode h2,
        body.bw-mode h3 {
            color: #000 !important;
        }


        @media print {
            @page {
                margin: 0.5in;
            }

            body {
                background: white;
                margin: 0;
                padding: 0;
            }

            .print-canvas {
                margin: 0;
                box-shadow: none;
                width: 100%;
                padding: 0;
                transform: none;
                /* No scale for actual print */
            }

            .no-print-area {
                display: none;
            }

            /* Black & White Printer Fix */
            .main-table th {
                background-color: #f2f2f2 !important;
                color: black !important;
                border: 1px solid #333 !important;
            }

            .grand-total-box {
                background-color: #eee !important;
                color: black !important;
                border: 2px solid black !important;
            }

            .class-group-header {
                background-color: #f9f9f9 !important;
                color: black !important;
                border: 1px solid #ddd !important;
            }
        }
    </style>
</head>

<body>
    <div class="no-print-area">
        <button class="btn btn-primary shadow" onclick="window.print()">
            <i class="fas fa-print me-2"></i>Print Document
        </button>
        <button class="btn btn-light ms-2 shadow" onclick="window.close()">
            <i class="fas fa-times me-2"></i>Close
        </button>

        <!-- Color/B&W Toggle -->
        <div class="form-check form-switch d-inline-block ms-3">
            <input class="form-check-input" type="checkbox" id="bwModeToggle" onchange="toggleBWMode()">
            <label class="form-check-label" for="bwModeToggle">
                <i class="fas fa-leaf me-1"></i>Eco / B&W Print Mode
            </label>
        </div>
    </div>

    <script>
        function toggleBWMode() {
            const isChecked = document.getElementById('bwModeToggle').checked;
            if (isChecked) {
                document.body.classList.add('bw-mode');
            } else {
                document.body.classList.remove('bw-mode');
            }
        }
    </script>

    <div class="print-canvas" id="printContent">
        <!-- HEADER -->
        <div class="header-section d-flex justify-content-between align-items-center">
            <div style="width: 30%;">
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                    class="company-logo" id="compLogo" style="display: none;" onerror="this.style.display='none'">
            </div>
            <div style="flex: 1; text-align: center;">
                <div style="display: inline-block; border-bottom: 2px solid #ccc; min-width: 150px; padding: 5px 10px;">
                    <span class="fs-2 fw-black text-dark" id="docNo"></span>
                </div>
            </div>
            <div class="doc-title" style="width: 30%;">
                <h1 id="documentType" style="font-size: 1.8rem;">TAX INVOICE</h1>
                <p>Date: <span id="docDate"></span></p>
            </div>
        </div>

        <!-- DETAILS GRID -->
        <div class="details-grid">
            <div class="info-card">
                <div class="info-label">From: Company Details</div>
                <div class="info-value" id="compName">My Company Name</div>
                <div id="compDetails" class="small text-muted">
                    Address Line 1<br>
                    Phone: 000-00000<br>
                    STRN: 123456 | NTN: 987654
                </div>
            </div>
            <div class="info-card">
                <div class="info-label" id="partyTypeLabel">To: Bill To</div>
                <div class="info-value" id="partyName">Customer Name</div>
                <div id="partyDetails" class="small text-muted">
                    Party Address<br>
                    Phone: 000-00000<br>
                    STRN: - | NTN: -
                </div>
            </div>
        </div>

        <!-- MAIN TABLE -->
        <table class="main-table" id="itemsTable">
            <thead>
                <tr>
                    <th style="width: 30px;">#</th>
                    <th style="width: 70px;">Code</th>
                    <th>Item Description</th>
                    <th style="width: 50px;">Qty</th>
                    <th style="width: 60px;">Price</th>
                    <th style="width: 60px;" id="thIncentive">Incentive</th>
                    <th style="width: 50px;">Disc %</th>
                    <th style="width: 60px;">Disc Rs</th>
                    <th style="width: 80px;">Total</th>
                </tr>
            </thead>
            <tbody id="itemsBody">
                <!-- Grouped Items will be inserted here -->
            </tbody>
        </table>

        <!-- TOTALS & REMARKS -->
        <div class="row g-4">
            <div class="col-6">
                <div class="info-card h-100">
                    <div class="info-label">Remarks / Terms</div>
                    <div id="docRemarks" class="small">
                        1. Goods once sold are not returnable.<br>
                        2. Payment must be made within 7 days.
                    </div>
                </div>
            </div>
            <div class="col-6">
                <table class="totals-table float-end">
                    <tr>
                        <td>Gross Amount</td>
                        <td class="text-end fw-bold" id="totalGross">0.00</td>
                    </tr>
                    <tr>
                        <td>Discount (-)</td>
                        <td class="text-end fw-bold text-danger" id="totalDisc">0.00</td>
                    </tr>
                    <tr>
                        <td>Net Amount</td>
                        <td class="text-end fw-bold" id="totalSub">0.00</td>
                    </tr>
                    <tr>
                        <td>Tax Total</td>
                        <td class="text-end fw-bold" id="totalTax">0.00</td>
                    </tr>
                    <tr>
                        <td>Misc Charges</td>
                        <td class="text-end fw-bold" id="totalMisc">0.00</td>
                    </tr>
                    <tr class="grand-total-box">
                        <td>Grand Total</td>
                        <td class="text-end" id="totalGrand">0.00</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- FOOTER SIGNATURES -->
        <div class="footer-signatures">
            <div class="sig-box">Receiver Signature</div>
            <div class="sig-box">Verified By</div>
            <div class="sig-box">Authorized Signature</div>
        </div>

        <div class="mt-5 text-center small text-muted">
            Printed on: <span id="printTime"></span> | System Generated Document
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type');
            const id = params.get('id');
            const token = localStorage.getItem('token');

            if (!id || !type) return alert('Invalid Request');

            try {
                // 1. Fetch Company Info
                const compRes = await fetch('/api/v1/settings/company-info', { headers: { 'Authorization': `Bearer ${token}` } });
                const compData = (await compRes.json()).data || {};

                // Set Company UI
                document.getElementById('compName').textContent = compData.companyName || 'BAS Software';
                document.getElementById('compDetails').innerHTML = `
                    ${compData.address || ''}<br>
                    Phone: ${compData.phone || ''} | Email: ${compData.email || ''}<br>
                    STRN: ${compData.taxNumber || 'N/A'} | NTN: ${compData.pan || 'N/A'}
                `;
                if (compData.logo) {
                    const logoImg = document.getElementById('compLogo');
                    logoImg.src = compData.logo;
                    logoImg.style.display = 'block';
                }

                // 2. Fetch Document Data
                let endpoint = '';
                let title = '';
                switch (type) {
                    case 'purchase': endpoint = `/api/v1/wh-purchases/${id}`; title = 'PURCHASE INVOICE'; break;
                    case 'purchase-return': endpoint = `/api/v1/wh-purchase-returns/${id}`; title = 'PURCHASE RETURN'; break;
                    case 'sale': endpoint = `/api/v1/wh-sales/${id}`; title = 'SALE INVOICE'; break;
                    case 'sale-return': endpoint = `/api/v1/wh-sale-returns/${id}`; title = 'SALE RETURN'; break;
                    case 'stock-audit': endpoint = `/api/v1/wh-stock-audits/${id}`; title = 'STOCK AUDIT REPORT'; break;
                }

                document.getElementById('documentType').textContent = title;

                const docRes = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${token}` } });
                const doc = (await docRes.json()).data;
                if (!doc) throw new Error('Document not found');

                // Set Doc UI
                let dNo = doc.invoiceNo || doc.postingNumber || doc.returnNo || doc.auditNo || 'N/A';

                // Shortcut formatting for print (e.g. INV-WS-2026-0001 -> INV-01)
                if (typeof dNo === 'string' && dNo.includes('-')) {
                    const parts = dNo.split('-');
                    const serialPart = parts[parts.length - 1];
                    if (!isNaN(serialPart)) {
                        const numericPart = parseInt(serialPart);
                        const paddedShort = String(numericPart).padStart(2, '0');
                        if (dNo.startsWith('INV-WS-')) dNo = `INV-${paddedShort}`;
                        else if (dNo.startsWith('SR-WS-')) dNo = `SR-${paddedShort}`;
                        else if (dNo.startsWith('PUR-')) dNo = `PUR-${paddedShort}`;
                        else if (dNo.startsWith('PR-WS-')) dNo = `PR-${paddedShort}`;
                    }
                }
                document.getElementById('docNo').textContent = dNo;
                const actualDate = doc.date || doc.invoiceDate || doc.returnDate || doc.createdAt;
                document.getElementById('docDate').textContent = actualDate ? new Date(actualDate).toLocaleDateString() : 'N/A';
                document.getElementById('docRemarks').textContent = doc.remarks || 'No remarks provided.';

                // Party Details
                const party = doc.supplier || doc.customer || {};
                document.getElementById('partyTypeLabel').textContent = (type === 'purchase' || type === 'purchase-return') ? 'From: Supplier' : 'To: Customer';
                document.getElementById('partyName').textContent = party.supplierName || party.customerName || party.name || 'General';
                document.getElementById('partyDetails').innerHTML = `
                    ${party.address || 'N/A'}<br>
                    Phone: ${party.phone || party.mobile || 'N/A'}
                `;

                // Add STRN/NTN dynamically
                let pNTN = party.customerNTN || party.supplierNTN || party.ntn || party.NTN;
                let pSTRN = party.strn || party.STRN;
                let taxInfo = '';
                if (pSTRN && pSTRN !== 'N/A' && pSTRN !== '-') taxInfo += `STRN: ${pSTRN}`;
                if (pNTN && pNTN !== 'N/A' && pNTN !== '-') taxInfo += (taxInfo ? ' | ' : '') + `NTN: ${pNTN}`;
                if (taxInfo) {
                    document.getElementById('partyDetails').innerHTML += `<br>${taxInfo}`;
                }

                // Totals Calculation Refinement from line items
                let calcBase = 0;
                let calcDisc = 0;
                let calcTax = 0;

                doc.items.forEach(line => {
                    const price = line.pcsPrice || line.costPrice || line.salePrice || line.price || 0;
                    const qty = line.quantity || line.returnQty || 0;
                    const itTax = line.taxAmount || line.taxRs || 0;
                    const itDisc = line.discountAmount || line.disRs || 0;

                    // Gross = Base Price * Qty (Value before tax or discount)
                    calcBase += (price * qty);
                    // Discount only includes the line-level discount amount (Disc Rs)
                    calcDisc += itDisc;
                    calcTax += itTax;
                });

                const globalDisc = doc.globalDiscountAmount || doc.totalDiscount || 0;
                const finalGross = calcBase + calcTax;
                const finalDisc = calcDisc + globalDisc;
                const finalNet = finalGross - finalDisc;

                document.getElementById('totalGross').textContent = finalGross.toLocaleString(undefined, { minimumFractionDigits: 2 });
                document.getElementById('totalDisc').textContent = finalDisc.toLocaleString(undefined, { minimumFractionDigits: 2 });
                document.getElementById('totalSub').textContent = finalNet.toLocaleString(undefined, { minimumFractionDigits: 2 });

                document.getElementById('totalTax').textContent = (doc.taxAmount || doc.totalTax || doc.globalTaxAmount || calcTax || 0).toLocaleString(undefined, { minimumFractionDigits: 2 });
                document.getElementById('totalGrand').textContent = (doc.grandTotal || doc.netTotal || doc.totalAmount || finalNet || 0).toLocaleString(undefined, { minimumFractionDigits: 2 });

                if (document.getElementById('totalMisc')) {
                    document.getElementById('totalMisc').textContent = (doc.miscCharges || doc.freightCharges || 0).toLocaleString(undefined, { minimumFractionDigits: 2 });
                }

                // Items Logic - GROUP BY ITEM CLASS
                const tbody = document.getElementById('itemsBody');
                tbody.innerHTML = '';

                // For Stock Audit, details are different
                if (type === 'stock-audit') {
                    renderAuditItems(doc.items, tbody);
                } else {
                    // Hide incentive column if not Sale
                    if (!type.includes('sale')) {
                        document.getElementById('thIncentive').style.display = 'none';
                    }
                    renderStandardItems(doc.items, tbody, type);
                }

                document.getElementById('printTime').textContent = new Date().toLocaleString();

            } catch (err) {
                console.error(err);
                alert('Printing failed: ' + err.message);
            }
        });

        function renderStandardItems(items, tbody, docType) {
            // Group by class
            const groups = {};
            items.forEach(line => {
                const item = line.item || {};
                const classObj = item.itemClass || {};
                const className = classObj.name || (typeof item.itemClass === 'string' ? item.itemClass : 'Uncategorized');
                if (!groups[className]) groups[className] = [];
                groups[className].push(line);
            });

            let globalIndex = 1;
            for (const className in groups) {
                // Header row for class
                const headerRow = document.createElement('tr');
                headerRow.className = 'class-group-header';
                headerRow.innerHTML = `<td colspan="10" class="ps-3">Class: ${className}</td>`;
                tbody.appendChild(headerRow);

                let classTotal = 0;
                groups[className].forEach(line => {
                    const item = line.item || {};
                    const tr = document.createElement('tr');
                    const total = parseFloat(line.total || line.netTotal || line.totalAmount || 0);
                    classTotal += total;

                    const price = line.pcsPrice || line.costPrice || line.salePrice || line.price || 0;
                    const incentive = line.incentive || 0;
                    const discPercent = line.discountPercent || line.disP || 0;
                    const discRs = line.discountAmount || line.disRs || 0;

                    let html = `
                        <td class="text-center">${globalIndex++}</td>
                        <td class="text-center">${item.itemsCode || item.code || ''}</td>
                        <td>
                            <div class="fw-bold">${item.name || line.name || 'N/A'}</div>
                            <small class="text-muted">${item.pack || ''}</small>
                        </td>
                        <td class="text-center">${line.quantity || line.returnQty || 0}</td>
                        <td class="text-end">${price.toFixed(2)}</td>`;

                    if (docType.includes('sale')) {
                        html += `<td class="text-center">${incentive.toFixed(2)}</td>`;
                    }

                    html += `
                        <td class="text-center">${discPercent}%</td>
                        <td class="text-end">${discRs.toFixed(2)}</td>
                        <td class="text-end fw-bold">${total.toFixed(2)}</td>
                    `;
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });

                // Subtotal row for class
                const subRow = document.createElement('tr');
                subRow.className = 'subtotal-row';
                const colSpan = docType.includes('sale') ? 8 : 7;
                subRow.innerHTML = `
                    <td colspan="${colSpan}" class="text-end">Sub Total (${className}):</td>
                    <td class="text-end fw-bold">${classTotal.toFixed(2)}</td>
                `;
                tbody.appendChild(subRow);
            }
        }

        function renderAuditItems(items, tbody) {
            // Update Headers for Audit
            const thead = document.querySelector('.main-table thead tr');
            thead.innerHTML = `
                <th style="width: 40px;">#</th>
                <th style="width: 80px;">Code</th>
                <th>Item Description</th>
                <th>Store</th>
                <th>System Qty</th>
                <th>Physical Qty</th>
                <th>Diff</th>
                <th>Cost</th>
                <th>Retail</th>
            `;

            items.forEach((line, index) => {
                const item = line.item || {};
                const tr = document.createElement('tr');
                const diff = (line.physicalQty || 0) - (line.systemQty || 0);

                tr.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td class="text-center">${item.itemsCode || item.code || ''}</td>
                    <td>
                        <div class="fw-bold">${item.name || line.name || 'N/A'}</div>
                        <small class="text-muted">${item.pack || ''}</small>
                    </td>
                    <td class="text-center">${line.store || 'Shop'}</td>
                    <td class="text-center">${line.systemQty || 0}</td>
                    <td class="text-center fw-bold">${line.physicalQty || 0}</td>
                    <td class="text-center ${diff < 0 ? 'text-danger' : (diff > 0 ? 'text-success' : '')} fw-bold">${diff}</td>
                    <td class="text-end">${(line.costPrice || 0).toFixed(2)}</td>
                    <td class="text-end">${(line.retailPrice || 0).toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>

</html>